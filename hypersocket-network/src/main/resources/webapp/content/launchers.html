<div id="contentLaunchers">
	<div class="modal" id="addLauncherForm" tabindex="-1" role="dialog" dialog-for="contentLaunchers">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="launcher.name.label"></label>
							<div class="propertyValue col-xs-9">
								<input type="text" class="form-control"
									placeholder="" id="resourceName" maxlength="" name="resourceName" value="">
								<div>
									<span class="help-block" localize="launcher.name.info"></span>
								</div>
							</div>
					</div>
					<div id="launcherProperties"></div>
					<div id="tabProgram" class="dialogTab">
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="launcher.os.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="osButton"></div>
								<div>
									<span class="help-block" localize="launcher.os.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="launcher.exe.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="exe"></div>
								<div>
									<span class="help-block" localize="launcher.exe.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="launcher.args.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="args"></div>
								<div>
									<span class="help-block" localize="launcher.args.info"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="tabScripts" class="dialogTab">
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="launcher.startup.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="startupScript"></div>
								<div>
									<span class="help-block" localize="launcher.startup.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="launcher.shutdown.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="shutdownScript"></div>
								<div>
									<span class="help-block" localize="launcher.shutdown.info"></span>
								</div>
							</div>
						</div>
					</div>
					<input type="hidden" id="resourceId" name="resourceId" value="" />
				</div>	
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
<div id="searchLaunchers">
	<div class="modal" id="searchLaunchersForm" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title" localize="text.searchTemplates"></h4>
				</div>
				<div class="modal-body">
					<div id="searchDialog" class="searchDialog">
						<div id="searchHeader" class="row">
							<div class="col-xs-6"></div>
							<label class="col-xs-2" localize="text.search"></label>
							<input class="col-xs-4" type="text" id="searchInput">
						</div>
						<div id="searchResults" class="row">
						
						</div>
						<div id="pages">
						
						</div>
					</div>
					<div id="templateInfo" class="searchDialog">
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="ssoPlugin.templateName.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="templateName"></div>
								<div>
									<span class="help-block" localize="ssoPlugin.templateName.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="ssoPlugin.usernameAttribute.label"></label>
							<div class="col-xs-9">
								<div class="propertyValue col-xs-4" style="padding-left: 0px;">
									<div id="usernameAttribute"></div>
	
								</div>
								<div class="propertyValue col-xs-8">
									<div id="usernameInput"></div>
								</div>
								<div>
									<span class="help-block" localize="ssoPlugin.usernameAttribute.info"></span>
							</div>
							</div>
							
						</div>
						<div class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="ssoPlugin.passwordAttribute.label"></label>
							<div class="col-xs-9">
								<div class="propertyValue col-xs-4" style="padding-left: 0px;">
									<div id="passwordAttribute"></div>
	
								</div>
								<div class="propertyValue col-xs-8">
									<div id="passwordInput"></div>
								</div>
								<div>
									<span class="help-block" localize="ssoPlugin.passwordAttribute.info"></span>
								</div>
							</div>
						</div>
						<div id="categoryDiv" class="propertyItem form-group">
							<label class="col-xs-3 control-label" localize="ssoPlugin.categoryName.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="categoryName"></div>
								<div>
									<span class="help-block" localize="ssoPlugin.categoryName.info"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="templateVariables" class="searchDialog">
					
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="addTemplate" class="btn btn-primary"><i class="fa fa-save"></i>Next</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="additionalActions"></div>
<script type="text/javascript">
	function populateResults(results) {
		var count = 0;
		$('#searchResults').empty();
		var currentElement = $('#searchResults').append('<div class="row"></div>');
		$.each(results, function(idx, obj) {
			debugger;
			if(count > 0 && ((count % 5) == 0)) {
				currentElement = $('#searchResults').append('<div class="row"></div>');
			}
			currentElement.append('<div id="template' + obj.id + '" class="col-xs-2 template"><a href="#"><div class="row"><img width="100px" src="'
					+ basePath
					+ '/api/launchers/image/' 
					+ obj.templateLogo 
					+ '"></div><div class="row"><span>' 
					+ obj.name
					+ '</span></div></a></div>');
			$('#template' + obj.id).data('template', obj);
			count++;
		});
	
		if(count < 10) {
			for(var i=count;i<10;i++) {
				if(count > 0 && ((count % 5) == 0)) {
					currentElement = $('#searchResults').append('<div class="row"></div>');
				}
				currentElement.append('<div class="col-xs-2 template"></div>');
				count++;
			}
		}
	
		$('.template a').off('click');
		$('.template a').on('click', function(e) {
			e.preventDefault();
			$('.selectedTemplate').removeClass('selectedTemplate');
			$(this).parent().addClass('selectedTemplate');
			$('#addTemplate').attr('disabled', false);
		});
	}

	$(document).ready(function() {
		
				$('#contentLaunchers').localize();
				$('#searchLaunchers').localize();
				
				$('#templateInfo').hide();
				
				var templateName = $('#templateName').textInput();
				var categoryName = $('#categoryName').textInput();
		
				var page = 0;
				
				var usernameAttribute = $('#usernameAttribute').selectButton({
					options:  [{ name: "option.fixed", value: 'fixed'}, { name: "option.admin", value: 'admin'}, { name: "option.user", value: 'user'}],
					value: 'admin',
					nameIsResourceKey: true,
					changed: function(widget) {
						if(widget.getValue() == 'fixed') {
							$('#usernameInput').show();
							if(!$('#passwordInput').is(':visible')) {
								$('#categoryDiv').show();
							} else {
								$('#categoryDiv').hide();
							}
						} else {
							$('#usernameInput').hide();
							$('#categoryDiv').show();
						}
					}
				});
				
				var passwordAttribute = $('#passwordAttribute').selectButton({
					options: [{ name: "option.fixed", value: 'fixed'}, { name: "option.admin", value: 'admin'}, { name: "option.user", value: 'user'}],
					value: 'admin',
					nameIsResourceKey: true,
					changed: function(widget) {
						if(widget.getValue() == 'fixed') {
							$('#passwordInput').show();
							if(!$('#usernameInput').is(':visible')) {
								$('#categoryDiv').show();
							} else {
								$('#categoryDiv').hide();
							}
						} else {
							$('#passwordInput').hide();
							$('#categoryDiv').show();
						}
					}
				});
				
				var usernameInput = $('#usernameInput').textInput();
				var passwordInput = $('#passwordInput').textInput({ inputType: 'password'});
				
				$('#usernameInput').hide();
				$('#passwordInput').hide();
				
				
				var osSelect = $('#osButton').selectButton({
					id: 'os',
					url: 'launchers/os',
					nameAttr: 'name',
					valueAttr: 'id',
					getUrlData: function(data) {
						return data.resources;
					},
					nameIsResourceKey: false,
					changed: function(os) {
					}
				});

				var exeInput = $('#exe').textInput({
					variables: [ 'hostname', 'username', 'client.username', 'client.userhome', 'client.userdir', 'timestamp']
				});
				
				$('#args').multipleTextInput({ 
					values : '',
					disabled : false, 
					resourceKey : 'args',
					allowOrdering: true,
					variables: [ 'hostname', 'username', 'client.username', 'client.userhome', 'client.userdir', 'timestamp']
				});
				
				$('#launcherProperties').propertyPage({
					url : 'launchers/template',
					showButtons : false,
					useTemplates : true,
					canUpdate : currentMenu.canUpdate,
					additionalTabs : [ {
						id : "tabProgram",
						name : getResource("tabProgram.label")
					}, {
						id : "tabScripts",
						name : getResource("tabScripts.label")
					}]
				});
				
				var startupScript = $('#startupScript').textInput({
					inputType: 'textarea',
					variables: [ 'hostname', 'username', 'client.username', 'client.userhome', 'client.userdir', 'timestamp']
				});

				var shutdownScript = $('#shutdownScript').textInput({
					inputType: 'textarea',
					variables: [ 'hostname', 'username', 'client.username', 'client.userhome', 'client.userdir', 'timestamp']
				});
				
				getJSON('menus/tableActions/applicationLauncherActions', null, function(data) {
					
					var actions = new Array();
					if(data.resources.length > 0) {
						$.each(data.resources, function(idx, action) {
							var div = action.resourceKey + 'Div';
							$('#additionalActions').append('<div id="' + div + '"></div>');
							$('#' + div).load('content/' + action.url + '.html');

							actions.push({
								resourceKey : action.resourceKey,
								iconClass : action.iconClass,
								action : function(resource, callback) {
									if($('#' + action.resourceKey).data('action')) {
										$('#' + action.resourceKey).data('action')(resource, callback);
									}
								},
								enabled : true,
								enableFunction: action.enableFunction,
								displayFunction: action.displayFunction
							});
						});
					}
				
					$('#contentLaunchers').ajaxResourcePage(
							{
								id : "Launcher",
								tableUrl : "launchers/table",
								title: getResource("launchers.label"),
								icon: 'fa-rocket',
								resourceUrl : "launchers/launcher",
								fields : [ {
									name : "name"
								}],
								resourceKey : "launcher",
								canCreate: currentMenu.canCreate,
								canUpdate: currentMenu.canUpdate,
								canDelete: currentMenu.canDelete,
								additionalActionsDropdown: true,
								additionalActions: actions,
								additionalButtons: [ { 
									resourceKey: 'applicationSearchOnline',
									buttonClass: 'btn-primary',
									icon: 'fa-search',
									action: function(callback) {
										$('#templateInfo').hide();
										$('#templateVariables').hide();
										$('#searchDialog').show();
										$('#searchResults').empty();
										$('#pages').empty();
										$('#addTemplate').children('i').removeClass('fa-spin fa-spinner');
										$('#addTemplate').children('i').addClass('fa-save');
										$('#pages').append('<div id="searchPages"></div>');
										
										var iDisplayStart = 0;
										var params = new Array();
										params['sSearch'] = $('#searchInput').val();
										params['iDisplayStart'] = iDisplayStart;
										params['iDisplayLength'] = 10;
										
										$('#addTemplate').attr('disabled', true);
										$('#addTemplate').off('click');
										
										$('#addTemplate').on('click', function(e) {
											removeMessage();
											var template = $('.selectedTemplate').data('template');
											
											switch(page) {
												case 0:
												{
													$('#searchDialog').hide();
													if(templateName.getValue().trim()=='') {
														templateName.setValue(template.name);
													}
													$('#templateInfo').show();
													page = 1;
													break;
												}
												case 1:
												{
													if(templateName.getValue().trim()=='') {
														showError('error.pleaseProvideAllDetails');
														return;
													}
													if($('#usernameInput').is(':visible') && usernameInput.getValue().trim()=='') {
														showError('error.pleaseProvideAllDetails');
														return;
													}
												
													if($('#passwordInput').is(':visible') && passwordInput.getValue().trim()=='') {
														showError('error.pleaseProvideAllDetails');
														return;
													}
												
													if($('#categoryDiv').is(':visible') && categoryName.getValue().trim()=='') {
														showError('error.pleaseProvideAllDetails');
														return;
													}
												
													page = 2;
													var variables = splitFix(template.variables);
													if(variables.length > 0) {
														$('#templateInfo').hide();
														$('#templateVariables').empty();
														$('#templateVariables').append('<div class="row"><p style="text-align: center; margin-bottom: 20px"><strong>' + getResource('info.additionalDetails') + '</strong></p></div>')
														$.each(variables, function(idx, obj) {
															var items = obj.split('=');
															var label = decodeURIComponent(items[0]);
															var info = decodeURIComponent(items[1]);
															info = replaceAll(info, '<', "&lt;")
															info = replaceAll(info, '>', '&gt;');
															var id = label.replace(/\s/g, "");
															var variable = id.substring(0,1).toLowerCase() + id.substring(1);
															$('#templateVariables').append('<div class="propertyItem form-group">'
																	+ '<label class="col-xs-3 control-label">' + label + '</label>'
																	+ '<div class="propertyValue col-xs-9"><div id="variable' + id + '" data-variable="' + variable + '" + class="variable"></div><div>'
																	+ '<span class="help-block">' + info + '</span></div></div></div>');
														
															$('#variable' + id).textInput();
														
														});
														$('#templateVariables').show();
													} else {
														page = 3;
														$('#addTemplate').trigger('click');
													}
													break;
												}
												case 2:
												{
													var valid = true;
													$('.variable').each(function(idx) {
														if($(this).widget().getValue().trim()=='') {
															valid = false;
														}
													});
													
													if(!valid) {
														showError('error.pleaseProvideAllDetails');
														return;
													}
												
													page = 3;
													$('#addTemplate').trigger('click');
													break;
												}
												case 3:
												{
													$('#addTemplate').children('i').removeClass('fa-save');
													$('#addTemplate').children('i').addClass('fa-spin fa-spinner');
									
													var data = template.script;
		 											
									            	var createUsernameAttribute = usernameAttribute.getValue() != 'fixed';
													var createPasswordAttribute = passwordAttribute.getValue() != 'fixed';
													var userProvidesUsername = usernameAttribute.getValue() == 'user';
													var userProvidesPassword = passwordAttribute.getValue() == 'user';
													var attributeCategory = categoryName.getValue();
													var name = templateName.getValue();

													data = replaceAll(data,'${templateName}', name);
																									
													data = replaceAll(data,'${attributeCategory}', attributeCategory);
													data = replaceAll(data,'${createUsernameAttribute}', createUsernameAttribute);
													data = replaceAll(data,'${createPasswordAttribute}', createPasswordAttribute);
													data = replaceAll(data,'${userProvidesUsername}', userProvidesUsername);
													data = replaceAll(data,'${userProvidesPassword}', userProvidesPassword);  
													
													if(usernameAttribute.getValue() == 'fixed') {
														data = replaceAll(data,'${principalName}', usernameInput.getValue());
													}
													if(passwordAttribute.getValue() == 'fixed') {
														data = replaceAll(data,'${password}', passwordInput.getValue());
													}

													$('.variable').each(function(idx) {
														var variable = $(this).data('variable');
														data = replaceAll(data, '${' + variable + '}', $(this).widget().getValue());
														data = replaceAll(data, encodeURIComponent('${' + variable + '}'), encodeURIComponent($(this).widget().getValue()));
													});
													
													$.post(basePath + '/api/launchers/script', { script: data }, function(data) {
														$('#addTemplate').children('i').removeClass('fa-spin fa-spinner');
														$('#addTemplate').children('i').addClass('fa-save');
														if(data.success) {
															loadResources(function() {
																$('#contentLaunchers').ajaxResourcePageInsert(data.resource);
																$('#searchLaunchersForm').modal('hide');
																showInformation(getResource('info.createdResource').format(data.resource.name));
															});
														} else {
															page = 0;
															$('#addTemplate').trigger('click');
															showError(data.message);
														}   
														
													});
		 											break;	
												}
																					
												default:
													{
														alert('Invaild page!');
													}

											}
										});
										
										$('#searchInput').change(function() {
											getJSON('launchers/search?iDisplayStart=0&iDisplayLength=10&sSearch=' + $('#searchInput').val(), params, function(data) {
												
												$('#pages').empty();
												$('#pages').append('<div id="searchPages"></div>');
												$('#searchResults').empty();
												
												if(data.aaData.length > 0) {
												
													populateResults(data.aaData);
													
													// init bootpag
											        $('#searchPages').bootpag({
											            total: data.iTotalRecords <= 10 ? 1 : (data.iTotalRecords / 10) + (data.iTotalRecords % 10 != 0 ? 1 : 0),
											            page: 1,
											            maxVisible: 10
											        }).on("page", function(event, num){
														if(num) {
												        	getJSON('launchers/search?iDisplayStart=' + ((num-1) * 10) + '&iDisplayLength=10&sSearch=' + $('#searchInput').val(), params, function(data) {
												        		populateResults(data.aaData);
															});
														}
											        	
											        });
												} else {
													$('#searchResults').append('<p style="width:100%; text-align: center; padding-top:50px;">' + getResource('info.noResults').format($('#searchInput').val()));
												}
												
											}, function(xmlRequest) {
												log('Failed to get online templates: ' + xmlRequest.status);
												showError('error.failedToSearchTemplates');
											});	
										});
										
										$('#searchInput').trigger('change');
										$('#searchLaunchersForm').modal({
											  backdrop: 'static',
											  keyboard: false
										});
										$('#searchLaunchersForm').off('hidden.bs.modal');
										$('#searchLaunchersForm').on('hidden.bs.modal', function () {
												 removeMessage();
										});
										$('#searchLaunchersForm').modal('show');
									}
								}],
								validate : function() {
	
									if ($('#resourceName').val() == '') {
										$('#addLauncherForm').resourceDialog(
												'error', "error.nameRequired");
										return false;
									}
	
									// TODO validate any of your other fields
									
									return true;
								},
								clearDialog : function() {
									
									$('#resourceId').val('');
									$('#resourceName').val('');
									exeInput.setValue('');
									$('#args').multipleTextInput({ values: []});
									osSelect.setValue(0);
									startupScript.setValue("");
									shutdownScript.setValue("");
									
									$('.launcherPropertiesTab').first().trigger('click');
								},
								createResource : function() {
									resource = new Object();
									resource.id = $('#resourceId').val();
									resource.name = $('#resourceName').val();
									resource.exe = exeInput.getValue();
									resource.args = fixSplit($('#args').multipleSelectValues());
									resource.os = osSelect.getValue();
									resource.startupScript = startupScript.getValue();
									resource.shutdownScript = shutdownScript.getValue();
									
									return resource;
								},
								displayResource : function(resource) {
									
									$('#resourceId').val(resource.id);
									$('#resourceName').val(resource.name);
									exeInput.setValue(resource.exe);
									$('#args').multipleTextInput({ values: splitFix(resource.args)});
									osSelect.setValue(resource.os.id);
									startupScript.setValue(resource.startupScript);
									shutdownScript.setValue(resource.shutdownScript);
									
								},
								complete : function() {
									loadComplete();
								}
							});
			    });
			});
</script>